<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Routine üå∏</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #fce4ec; padding: 0; margin: 0; padding-bottom: 80px; }
        
        /* === BUTTONS & UI === */
        .menu-btn {
            position: fixed; top: 15px; left: 15px; font-size: 20px; cursor: pointer; color: #ad1457;
            background: white; padding: 8px 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 2500;
        }

        .edit-btn {
            position: fixed; top: 15px; right: 15px; font-size: 14px; cursor: pointer; color: white;
            background: #ad1457; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            z-index: 1000; font-weight: bold; border: 2px solid white; transition: 0.3s;
        }
        .edit-btn.editing { background: #28a745; }

        /* === ROMANTIC MODAL === */
        #romanticModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(252, 228, 236, 0.8); backdrop-filter: blur(8px);
            z-index: 3000; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 25px; text-align: center;
            box-shadow: 0 15px 35px rgba(233, 30, 99, 0.25); border: 3px solid #fff0f6; 
            width: 85%; max-width: 320px; animation: floatUp 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes floatUp { from { transform: translateY(50px) scale(0.8); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .modal-box h3 { color: #ad1457; margin-top: 0; font-family: 'Courier New', monospace; font-size: 20px; }
        .modal-box p { color: #880e4f; font-size: 13px; margin-bottom: 15px; }
        .modal-input {
            width: 85%; padding: 12px; border: 2px solid #f8bbd0; border-radius: 50px;
            text-align: center; outline: none; color: #ad1457; font-size: 16px; margin-bottom: 20px;
            background: #fffbfd; transition: 0.3s;
        }
        .modal-input:focus { border-color: #ec407a; box-shadow: 0 0 10px rgba(236, 64, 122, 0.2); }
        .modal-actions { display: flex; justify-content: center; gap: 10px; }
        .modal-btn-confirm {
            padding: 10px 25px; background: linear-gradient(45deg, #ec407a, #d81b60); 
            color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold;
            box-shadow: 0 5px 15px rgba(236, 64, 122, 0.3);
        }
        .modal-btn-cancel {
            padding: 10px 20px; background: #fff0f6; color: #ad1457; border: 1px solid #f8bbd0;
            border-radius: 50px; cursor: pointer; font-weight: bold;
        }

        /* === CONTENT STYLES === */
        .header { text-align: center; margin-top: 70px; margin-bottom: 20px; }
        h2 { color: #ad1457; font-family: 'Courier New', monospace; margin: 0; }
        p { font-size: 12px; color: #880e4f; }

        .tab-container {
            display: flex; justify-content: space-around; background: white;
            padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100;
        }
        .tab-btn {
            background: none; border: none; font-weight: bold; color: #880e4f;
            padding: 8px 12px; border-radius: 20px; cursor: pointer; transition: 0.3s; font-size: 14px;
        }
        .tab-btn.active { background: #ec407a; color: white; box-shadow: 0 2px 5px rgba(236, 64, 122, 0.4); }

        .day-container { padding: 15px; padding-bottom: 100px; min-height: 300px; }

        .class-card {
            background: white; padding: 15px; border-radius: 15px;
            box-shadow: 0 4px 10px rgba(233, 30, 99, 0.1);
            display: flex; flex-direction: column; gap: 5px;
            margin-bottom: 15px; border-left: 5px solid #ec407a; position: relative;
        }
        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .time-box { font-size: 13px; color: #ec407a; font-weight: bold; width: 75%; }
        
        .subject-box textarea {
            width: 100%; border: none; font-family: inherit; font-size: 16px; color: #333;
            background: transparent; resize: none; height: 40px; font-weight: bold; margin-top: 5px;
        }
        .subject-box textarea:focus { outline: none; border-bottom: 1px solid #ec407a; background: #fffbfd; }
        .subject-box textarea[readonly] { color: #555; border-bottom: none; background: transparent; }

        .class-check { transform: scale(1.5); accent-color: #d81b60; cursor: pointer; }
        .delete-btn { color: #ff5252; background: none; border: none; font-size: 16px; cursor: pointer; display: none; }
        
        .add-class-btn {
            display: none; width: 100%; padding: 12px; background: #fff0f6; border: 2px dashed #ec407a;
            color: #ad1457; font-weight: bold; border-radius: 15px; cursor: pointer; margin-bottom: 20px; transition: 0.2s;
        }

        /* === REWARD BOX === */
        .reward-box {
            background: #fff0f6; padding: 20px; border-radius: 15px;
            text-align: center; border: 2px dashed #ec407a; margin-top: 20px;
        }
        .heart-checkbox { appearance: none; font-size: 40px; pointer-events: none; transition: 0.5s; }
        .heart-checkbox::before { content: 'üîí'; opacity: 0.5; font-size: 30px; }
        .heart-checkbox:checked::before { content: '‚ù§Ô∏è'; }
        .heart-checkbox:checked { transform: scale(1.2); filter: drop-shadow(0 0 10px rgba(233, 30, 99, 0.4)); }
        
        .surprise-msg { 
            display: none; margin-top: 15px; color: #ad1457; font-weight: bold; font-size: 16px;
            animation: popUp 0.5s; padding: 10px; background: white; border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        @keyframes popUp { 0% { transform: scale(0.5); } 100% { transform: scale(1); } }

        .btn-container { text-align: center; margin-top: 20px; display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .save-btn { padding: 15px 50px; background: linear-gradient(45deg, #ec407a, #d81b60); color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 18px; box-shadow: 0 5px 15px rgba(236, 64, 122, 0.4); }
        .reset-btn { padding: 10px 30px; background: #ff5252; color: white; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

    <div id="sidebar-placeholder"></div>

    <div class="menu-btn" onclick="openNav()">‚ò∞</div>
    <button id="editBtn" class="edit-btn" onclick="triggerEdit()">‚úé Edit</button>

    <div id="romanticModal">
        <div class="modal-box">
            <h3 id="modalTitle">Title ‚ù§Ô∏è</h3>
            <p id="modalSub">Subtitle</p>
            <input type="text" id="modalInput" class="modal-input" placeholder="...">
            <div class="modal-actions">
                <button class="modal-btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-btn-confirm" id="modalConfirmBtn">Done üå∏</button>
            </div>
        </div>
    </div>

    <div class="header">
        <h2>‚ú® Daily Routine ‚ú®</h2>
        <p>Complete tasks to unlock rewards!</p>
    </div>

    <div class="tab-container">
        <button class="tab-btn active" onclick="switchDay(0)">Sun</button>
        <button class="tab-btn" onclick="switchDay(1)">Mon</button>
        <button class="tab-btn" onclick="switchDay(2)">Tue</button>
        <button class="tab-btn" onclick="switchDay(3)">Wed</button>
        <button class="tab-btn" onclick="switchDay(4)">Thu</button>
    </div>

    <div id="dynamic-content" class="day-container"></div>

    <div class="btn-container">
        <button class="save-btn" onclick="saveData()">Save Progress ‚ù§Ô∏è</button>
        <button class="reset-btn" onclick="resetData()">Reset Everything üîÑ</button>
    </div>

    <script src="sidebar.js"></script>

    <script>
        // === 1. DATA CONFIGURATION ===
        const defaultRoutine = [
            [{ time: "9:30 am - 12:20 pm", subject: "PHB102L-03 -DRJ-10D-22L", completed: false }, { time: "12:30 pm - 1:50 pm", subject: "PHB103-01 -TMZ-07F-24C", completed: false }, { time: "2:00 pm - 3:20 pm", subject: "PHB102-01 -DRJ-07F-24C", completed: false }, { time: "3:30 pm - 4:50 pm", subject: "PHB104-01 -DHY-07F-23C", completed: false }],
            [{ time: "9:30 am - 10:50 am", subject: "PHB101-01 -MRO-07F-25C", completed: false }],
            [{ time: "9:30 am - 12:20 pm", subject: "PHB104L-03 -GMAI-11F-34L", completed: false }, { time: "12:30 pm - 1:50 pm", subject: "PHB103-01 -TMZ-07F-24C", completed: false }, { time: "2:00 pm - 3:20 pm", subject: "PHB102-01 -DRJ-07F-24C", completed: false }, { time: "3:30 pm - 4:50 pm", subject: "PHB104-01 -DHY-07F-23C", completed: false }],
            [{ time: "9:30 am - 10:50 am", subject: "PHB101-01 -MRO-07F-25C", completed: false }],
            [] // Thursday
        ];

        // Mapping Days to Keys (Matches Admin Panel)
        const dayKeys = ["Sun", "Mon", "Tue", "Wed", "Thu"];

        let currentRoutine = [];
        let activeDay = 0;
        let isEditing = false;

        // === 2. INITIALIZATION ===
        window.onload = function() {
            loadData();
            fetchSecretMessages(); // Fetch admin msg immediately
            renderRoutine();
        };

        // === 3. RENDER FUNCTION (UPDATED) ===
        function renderRoutine() {
            const container = document.getElementById("dynamic-content");
            container.innerHTML = "";

            // Get tasks for current day
            const tasks = currentRoutine[activeDay];
            
            // Generate Task Cards
            tasks.forEach((task, index) => {
                const card = document.createElement("div");
                card.className = "class-card";
                card.innerHTML = `
                    <div class="card-header">
                        <div class="time-box">${task.time}</div>
                        <input type="checkbox" class="class-check" 
                            onchange="toggleTask(${activeDay}, ${index})" 
                            ${task.completed ? "checked" : ""}>
                        
                        <button class="delete-btn" onclick="deleteTask(${index})" 
                            style="display: ${isEditing ? 'block' : 'none'}">üóëÔ∏è</button>
                    </div>
                    <div class="subject-box">
                        <textarea 
                            onchange="updateSubject(${activeDay}, ${index}, this.value)" 
                            ${isEditing ? "" : "readonly"}>${task.subject}</textarea>
                    </div>
                `;
                container.appendChild(card);
            });

            // Add Class Button
            const addBtn = document.createElement("button");
            addBtn.className = "add-class-btn";
            addBtn.innerText = "+ Add Time Slot";
            addBtn.onclick = addNewClass;
            addBtn.style.display = isEditing ? "block" : "none";
            container.appendChild(addBtn);

            // === REWARD & MESSAGE LOGIC ===
            const allCompleted = tasks.length > 0 && tasks.every(t => t.completed);
            
            // Get the message for THIS specific day
            const dayKey = dayKeys[activeDay]; // e.g., "Sun"
            const savedRewards = JSON.parse(localStorage.getItem("adminRewards")) || {};
            
            // If admin message exists, use it. Else default.
            const adminMsg = savedRewards[dayKey] && savedRewards[dayKey].trim() !== "" 
                             ? savedRewards[dayKey] 
                             : "YAY! You finished everything! Proud of you! ‚ù§Ô∏è";

            const rewardBox = document.createElement("div");
            rewardBox.className = "reward-box";
            rewardBox.innerHTML = `
                <input type="checkbox" class="heart-checkbox" ${allCompleted ? "checked" : ""}>
                <div style="font-size:12px; margin-top:5px; color:#880e4f;">
                    ${allCompleted ? "Completed! üéâ" : "Tasks Locked üîí"}
                </div>
                <div class="surprise-msg" style="display: ${allCompleted ? 'block' : 'none'}">
                    ${adminMsg}
                </div>
            `;
            container.appendChild(rewardBox);

            // Update Tab Styles
            document.querySelectorAll(".tab-btn").forEach((btn, idx) => {
                btn.classList.toggle("active", idx === activeDay);
            });
        }

        // === 4. CORE FUNCTIONS ===
        function switchDay(dayIndex) {
            activeDay = dayIndex;
            renderRoutine();
        }

        function toggleTask(day, index) {
            currentRoutine[day][index].completed = !currentRoutine[day][index].completed;
            saveData(); // Save check state
            renderRoutine(); // Re-render to show message if all done
        }

        function updateSubject(day, index, val) {
            currentRoutine[day][index].subject = val;
        }

        function deleteTask(index) {
            if(confirm("Delete this class? üóëÔ∏è")) {
                currentRoutine[activeDay].splice(index, 1);
                renderRoutine();
            }
        }

        function addNewClass() {
            showRomanticPrompt("New Class? üïí", "Time?", "e.g. 10:00 am", "text", (time) => {
                currentRoutine[activeDay].push({ time: time, subject: "New Subject", completed: false });
                renderRoutine();
            });
        }

        // === 5. EDIT MODE & MODAL ===
        function triggerEdit() {
            if (isEditing) {
                isEditing = false;
                document.getElementById("editBtn").innerText = "‚úé Edit";
                document.getElementById("editBtn").classList.remove("editing");
                saveData();
                renderRoutine();
            } else {
                showRomanticPrompt("Enter Code üòò", "Only for you!", "****", "number", (val) => {
                    if (val === "0812") {
                        isEditing = true;
                        const btn = document.getElementById("editBtn");
                        btn.innerText = "‚úì Done";
                        btn.classList.add("editing");
                        renderRoutine();
                    } else {
                        alert("Wrong code baby ü•∫");
                    }
                });
            }
        }

        function showRomanticPrompt(title, sub, placeholder, type, callback) {
            const modal = document.getElementById("romanticModal");
            document.getElementById("modalTitle").innerText = title;
            document.getElementById("modalSub").innerText = sub;
            const input = document.getElementById("modalInput");
            input.value = "";
            input.placeholder = placeholder;
            input.type = type;
            modal.style.display = "flex";
            input.focus();
            document.getElementById("modalConfirmBtn").onclick = function() {
                if(input.value) { callback(input.value); closeModal(); }
            };
        }
        function closeModal() { document.getElementById("romanticModal").style.display = "none"; }

        // === 6. DATA STORAGE ===
        function saveData() {
            localStorage.setItem("myRoutineData_v5", JSON.stringify(currentRoutine));
        }

        function loadData() {
            const saved = localStorage.getItem("myRoutineData_v5");
            if (saved) currentRoutine = JSON.parse(saved);
            else currentRoutine = JSON.parse(JSON.stringify(defaultRoutine));
        }

        function resetData() {
            if(confirm("Reset EVERYTHING? üòÆ")) {
                localStorage.removeItem("myRoutineData_v5");
                location.reload();
            }
        }
        
        // Navigation Logic
        function openNav() { document.getElementById("mySidenav").style.width = "250px"; }
        function closeNav() { document.getElementById("mySidenav").style.width = "0"; }

        // === 7. CLOUD SYNC (GET ADMIN MSG) ===
        const REMOTE_BIN_ID = "697a8010d0ea881f408e87d7"; 
        const REMOTE_API_KEY = "$2a$10$vhszPYO/HWMSbnMiDUcq7eIW6i8BecKgdG6QteMm/FPJ/22fP/VBS";

        async function fetchSecretMessages() {
            try {
                let response = await fetch(`https://api.jsonbin.io/v3/b/${REMOTE_BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': REMOTE_API_KEY }
                });
                if (response.ok) {
                    let result = await response.json();
                    
                    // Save ONLY the routine messages to local storage
                    // Uses 'routine_obj' which is the new Object format
                    if (result.record.routine_obj) {
                        localStorage.setItem('adminRewards', JSON.stringify(result.record.routine_obj));
                        // Re-render to show updated message immediately
                        renderRoutine();
                    }
                }
            } catch (error) { 
                console.log("Offline or Sync Error"); 
            }
        }
    </script>
</body>
</html>
